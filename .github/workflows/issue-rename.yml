name: Auto Rename Issue

on:
  issues:
    types: [opened]

jobs:
  rename:
    runs-on: ubuntu-latest
    if: startsWith(github.event.issue.title, '[Prompt]:')
    permissions:
      issues: write
    steps:
      - name: Extract title from body
        id: extract
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "Extracting title from body..."
          TITLE=$(echo "$ISSUE_BODY" | sed -n '/### 標題/,/###/p' | grep -v '###' | grep -v '^[[:space:]]*$' | head -n 1 | xargs)
          echo "Extracted: $TITLE"
          if [ -n "$TITLE" ] && [ "$TITLE" != "_No response_" ]; then
            echo "extracted_title=$TITLE" >> $GITHUB_OUTPUT
          fi

      - name: Update Issue Title
        if: steps.extract.outputs.extracted_title != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_VAL: ${{ steps.extract.outputs.extracted_title }}
        run: |
          gh issue edit ${{ github.event.issue.number }} --repo ${{ github.repository }} --title "[Prompt]: $NEW_VAL"
